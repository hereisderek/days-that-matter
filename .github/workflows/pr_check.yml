name: PR Check

on:
  pull_request:
    branches: [ master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Inject Mock Secrets
        run: |
          cp composeApp/google-services.json.mock composeApp/google-services.json
          # Create a dummy keystore for debug builds if needed, or rely on the one in repo if committed (we committed debug.keystore)
          # If debug.keystore is in docs/keystore/debug.keystore, we ensure it's there.
          # The build.gradle.kts points to rootProject.file("docs/keystore/debug.keystore")

      - name: Run Unit Tests
        run: ./gradlew testDebugUnitTest

      - name: Run Lint
        run: ./gradlew lintDebug

      - name: Build Debug APK
        run: |
          ./gradlew :composeApp:assembleDebug
          
          # Extract versionName
          VERSION_NAME=$(grep 'versionName =' composeApp/build.gradle.kts | sed 's/.*= "\(.*\)".*/\1/')
          VERSION_CODE=1 # Default for debug
          COMMIT_HASH=$(git rev-parse --short HEAD)
          DATE=$(date +%Y%m%d)
          
          FILENAME="${VERSION_NAME}(${VERSION_CODE})_${COMMIT_HASH}.${DATE}.snapshot.apk"
          mv composeApp/build/outputs/apk/debug/composeApp-debug.apk "composeApp/build/outputs/apk/debug/${FILENAME}"
          
          echo "ARTIFACT_PATH=composeApp/build/outputs/apk/debug/${FILENAME}" >> $GITHUB_ENV

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: ${{ env.ARTIFACT_PATH }}

